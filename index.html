<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prompt AI per Giornalisti</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <h1>Generatore di Prompt AI per Giornalisti</h1>
        <p>Personalizza i tuoi prompt per l'intelligenza artificiale a partire da template professionali.</p>
    </header>
    <main>
        <div class="main-content-wrapper">
            <div id="filter-container">
                <select id="category-filter">
                    <option value="">Tutte le categorie</option>
                </select>
                <input type="text" id="search-input" placeholder="Cerca prompt per titolo o descrizione..." />
            </div>
            <div id="prompt-container">
                <div id="loading-spinner" class="spinner-container">
                    <div class="spinner"></div>
                    <span>Caricamento prompt...</span>
                </div>
            </div>
        </div>
    </main>

    <div class="feedback-section">
        <p>Cosa ne pensi dopo i primi test?</p>
        <a href="https://docs.google.com/forms/d/e/1FAIpQLScxgkTY3S5rRAOpGjGteuPzDX41UpNshxmEpKzge__ASIplVA/viewform?usp=dialog"
            target="_blank"
            class="feedback-button">Lascia un Feedback</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        // ID del tuo Foglio Google - Questo DEVE rimanere fisso qui per l'app
        const sheetID = "1uDoHvedmUcczP4rjI0GNZWOWstMPfhYuUahNPPbMoxg";
        const sheetRange = "Prompt Prestabiliti!A2:G"; // <-- Il range rimane lo stesso

        // L'URL della tua Netlify Function per Google Sheets
        const NETLIFY_FUNCTION_URL = "/.netlify/functions/get-my-sheets";

        // --- INIZIO AGGIUNTE PER INTEGRAZIONE GEMINI ---
        // L'URL della tua Netlify Function per Gemini
        const GEMINI_FUNCTION_URL = "/.netlify/functions/call-gemini";
        // --- FINE AGGIUNTE PER INTEGRAZIONE GEMINI ---

        const promptContainer = document.getElementById("prompt-container");
        const loadingSpinner = document.getElementById("loading-spinner");

        async function fetchPrompts() {
            // Mostra lo spinner prima di iniziare il fetch
            loadingSpinner.classList.remove("hidden");
            promptContainer.innerHTML = ''; // Pulisci il container per sicurezza prima di mostrare lo spinner

            try {
                const response = await fetch(NETLIFY_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ sheetId: sheetID, sheetRange: sheetRange }), // Qui vengono passati i dati
                });

                console.log("DEBUG: 1. Sto provando a scaricare i prompt da Netlify Function.");

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error(`DEBUG: 2. Errore nella risposta della Netlify Function: ${response.status}. Dettagli:`, errorData);
                    throw new Error(`Errore nel caricamento dei dati: ${errorData.error || response.statusText}`);
                }

                const data = await response.json();
                console.log("DEBUG: 3. Dati RAW ricevuti dalla Netlify Function:", data);

                if (!data.values || data.values.length === 0) {
                    console.warn("DEBUG: 4. Nessun dato 'values' trovato nel foglio o foglio vuoto.");
                }
                return data.values || [];
            } catch (error) {
                console.error("DEBUG: 5. Errore CATCH durante il recupero dei prompt dalla Netlify Function:", error);
                alert("Si è verificato un errore nel caricamento dei prompt. Riprova più tardi o controlla la configurazione della funzione Netlify.");
                return [];
            } finally {
                // Nascondi lo spinner una volta che il fetch è completato (sia successo che fallimento)
                loadingSpinner.classList.add("hidden");
            }
        }

        function creaCard(titolo, descrizione, promptTemplate, categoria, labelTesto, placeholderText, labelLang, index) {
            console.log(`DEBUG: 6. CreaCard chiamata per "${titolo}" - promptTemplate: "${promptTemplate}" - labelLang (Col. G): "${labelLang}"`);

            const card = document.createElement("div");
            card.className = "prompt-card";
            card.dataset.categoria = categoria?.toLowerCase() || "";

            const cardHeader = document.createElement("div");
            cardHeader.className = "card-header";
            cardHeader.setAttribute("role", "button");
            cardHeader.setAttribute("aria-expanded", "false");
            cardHeader.setAttribute("tabindex", "0");

            const headerTitle = document.createElement("h3");
            headerTitle.textContent = titolo;

            const icon = document.createElement("span");
            icon.className = "icon";
            icon.innerHTML = "&#9660;";

            cardHeader.appendChild(headerTitle);
            cardHeader.appendChild(icon);

            const cardContent = document.createElement("div");
            cardContent.className = "card-content";
            cardContent.setAttribute("aria-hidden", "true");

            const descElement = document.createElement("p");
            descElement.textContent = descrizione;

            const esperienzaLabel = document.createElement("label");
            esperienzaLabel.textContent = "Tema o campo di esperienza principale:";
            const esperienzaInput = document.createElement("input");
            esperienzaInput.placeholder = "es. economia, esteri, politica...";
            esperienzaInput.id = `esperienza-${index}`;

            const genereLabel = document.createElement("label");
            genereLabel.textContent = "Genere di giornalismo:";
            const genereInput = document.createElement("input");
            genereInput.placeholder = "es. cronaca, cultura, sport...";
            genereInput.id = `genere-${index}`;

            const testataLabel = document.createElement("label");
            testataLabel.textContent = "Nome della testata:";
            const testataInput = document.createElement("input");
            testataInput.placeholder = "es. Il Sole 24 Ore, La Repubblica...";
            testataInput.id = `testata-${index}`;

            const output = document.createElement("div");
            output.className = "prompt-output";
            // Inizialmente, impostiamo un messaggio di base. Marked.parse verrà usato dopo.
            output.innerHTML = "Il prompt personalizzato apparirà qui dopo la generazione.";

            // --- INIZIO AGGIUNTE PER CARICAMENTO AI ---
            const aiLoadingIndicator = document.createElement("div");
            aiLoadingIndicator.className = "ai-loading-indicator";
            aiLoadingIndicator.style.display = 'none'; // Inizialmente nascosto
            aiLoadingIndicator.innerHTML = '<div class="ai-spinner"></div><span>Generazione risposta AI...</span>';
            // --- FINE AGGIUNTE PER CARICAMENTO AI ---

            const buttonGroup = document.createElement("div");
            buttonGroup.className = "button-group";

            const generatePromptButton = document.createElement("button");
            generatePromptButton.textContent = "Genera prompt";
            generatePromptButton.className = "generate-prompt-button"; // Nuova classe per distinguere
            generatePromptButton.onclick = () => {
                let finalPrompt = promptTemplate
                    .replace(/\[ESPERIENZA\]/g, esperienzaInput.value || "[ESPERIENZA]")
                    .replace(/\[GENERE\]/g, genereInput.value || "[GENERE]")
                    .replace(/\[TESTATA\]/g, testataInput.value || "[TESTATA]");

                const textAreaInput = cardContent.querySelector(`#area-text-${index}`);
                if (textAreaInput) {
                    finalPrompt = finalPrompt.replace(/\[AREA_TEXT\]/g, textAreaInput.value || "[AREA_TEXT]");
                } else {
                    finalPrompt = finalPrompt.replace(/\[AREA_TEXT\]/g, '');
                }

                const langSelect = cardContent.querySelector(`#lang-${index}`);
                if (langSelect) {
                    finalPrompt = finalPrompt.replace(/\[LANG\]/g, langSelect.value || "[LANG]");
                } else {
                    finalPrompt = finalPrompt.replace(/\[LANG\]/g, '');
                }

                if (promptTemplate.includes("[DETTAGLI]")) {
                    const dettagliInput = cardContent.querySelector(`#dettagli-${index}`);
                    finalPrompt = finalPrompt.replace(/\[DETTAGLI\]/g, dettagliInput ? dettagliInput.value || "[DETTAGLI]" : "[DETTAGLI]");
                }

                // *** CORREZIONE QUI: Usa marked.parse per il prompt generato ***
                output.innerHTML = marked.parse(finalPrompt);
                output.style.color = '#444'; // Colore normale del testo del prompt
            };

            const copyButton = document.createElement("button");
            copyButton.textContent = "Copia prompt";
            copyButton.className = "copy-button";
            copyButton.onclick = () => {
                // Per copiare il testo corretto, prendiamo il testo dal div output.
                // Se `marked.parse` è stato usato, `innerText` restituirà il testo "pulito" (senza tag HTML)
                const textToCopy = output.innerText;
                const tempTextarea = document.createElement("textarea");
                tempTextarea.value = textToCopy;
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                document.execCommand("copy");
                document.body.removeChild(tempTextarea);
                copyButton.textContent = "Copiato!";
                setTimeout(() => copyButton.textContent = "Copia prompt", 1500);
            };

            // --- INIZIO AGGIUNTE PER IL BOTTONE "GENERA RISPOSTA AI" ---
            const generateAIResponseButton = document.createElement("button");
            generateAIResponseButton.textContent = "Genera risposta AI";
            generateAIResponseButton.className = "ai-generate-button";
            generateAIResponseButton.onclick = async () => {
                // 1. Assicurati che il prompt sia già stato generato
                // Qui usiamo il prompt generato dal bottone 'Genera prompt', ma il suo valore puro
                let finalPromptForAI = promptTemplate
                    .replace(/\[ESPERIENZA\]/g, esperienzaInput.value || "[ESPERIENZA]")
                    .replace(/\[GENERE\]/g, genereInput.value || "[GENERE]")
                    .replace(/\[TESTATA\]/g, testataInput.value || "[TESTATA]");

                const textAreaInput = cardContent.querySelector(`#area-text-${index}`);
                if (textAreaInput) {
                    finalPromptForAI = finalPromptForAI.replace(/\[AREA_TEXT\]/g, textAreaInput.value || "[AREA_TEXT]");
                } else {
                    finalPromptForAI = finalPromptForAI.replace(/\[AREA_TEXT\]/g, '');
                }

                const langSelect = cardContent.querySelector(`#lang-${index}`);
                if (langSelect) {
                    finalPromptForAI = finalPromptForAI.replace(/\[LANG\]/g, langSelect.value || "[LANG]");
                } else {
                    finalPromptForAI = finalPromptForAI.replace(/\[LANG\]/g, '');
                }

                if (promptTemplate.includes("[DETTAGLI]")) {
                    const dettagliInput = cardContent.querySelector(`#dettagli-${index}`);
                    finalPromptForAI = finalPromptForAI.replace(/\[DETTAGLI\]/g, dettagliInput ? dettagliInput.value || "[DETTAGLI]" : "[DETTAGLI]");
                }

                // Controlla se il prompt è ancora nel suo stato iniziale o di errore
                if (!finalPromptForAI || output.innerHTML.includes("Il prompt personalizzato apparirà qui dopo la generazione.")) {
                    alert("Per favore, genera prima il prompt personalizzato.");
                    return;
                }

                // 2. Mostra l'indicatore di caricamento
                aiLoadingIndicator.style.display = 'flex'; // Mostra il contenitore flex per spinner e testo
                output.innerHTML = "Generazione della risposta AI in corso..."; // Messaggio temporaneo
                output.style.color = '#888'; // Colore per indicare stato di caricamento

                try {
                    const response = await fetch(GEMINI_FUNCTION_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ prompt: finalPromptForAI }), // Passa il prompt pulito all'AI
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Errore nella risposta della Cloud Function Gemini:", errorData);
                        output.innerHTML = `Errore AI: ${errorData.error || response.statusText}. Riprova.`;
                        output.style.color = '#cc0000'; // Colore per errore
                        return;
                    }

                    const data = await response.json();
                    if (data.aiResponse) {
                        // CONVERTI IL MARKDOWN IN HTML QUI
                        output.innerHTML = marked.parse(data.aiResponse);
                        output.style.color = '#222'; // Colore normale per la risposta AI
                    } else {
                        output.innerHTML = "Nessuna risposta AI ricevuta.";
                        output.style.color = '#888';
                    }

                } catch (error) {
                    console.error("Errore durante la chiamata alla Cloud Function Gemini:", error);
                    output.innerHTML = "Errore durante la generazione della risposta AI. Controlla la console per dettagli.";
                    output.style.color = '#cc0000';
                } finally {
                    aiLoadingIndicator.style.display = 'none'; // Nasconde l'indicatore di caricamento
                }
            };
            // --- FINE AGGIUNTE PER IL BOTTONE "GENERA RISPOSTA AI" ---


            buttonGroup.appendChild(generatePromptButton);
            buttonGroup.appendChild(copyButton);
            // Aggiungi il bottone per la generazione AI al buttonGroup
            buttonGroup.appendChild(generateAIResponseButton);

            cardContent.appendChild(descElement);
            cardContent.appendChild(esperienzaLabel);
            cardContent.appendChild(esperienzaInput);
            cardContent.appendChild(genereLabel);
            cardContent.appendChild(genereInput);
            cardContent.appendChild(testataLabel);
            cardContent.appendChild(testataInput);

            // Logica per aggiungere campi input dinamici in base a labelTesto e placeholderText
            if (labelTesto && placeholderText) {
                const dynamicLabel = document.createElement("label");
                dynamicLabel.textContent = labelTesto;
                const dynamicTextarea = document.createElement("textarea");
                dynamicTextarea.placeholder = placeholderText;
                dynamicTextarea.id = `area-text-${index}`; // Assegna un ID unico
                cardContent.appendChild(dynamicLabel);
                cardContent.appendChild(dynamicTextarea);
            }

            // Logica per aggiungere il campo di selezione lingua
            if (labelLang === "TRUE") { // Controlla la colonna G del foglio
                const langLabel = document.createElement("label");
                langLabel.textContent = "Seleziona la lingua della risposta:";
                const langSelect = document.createElement("select");
                langSelect.id = `lang-${index}`;
                langSelect.innerHTML = `
                    <option value="italiano">Italiano</option>
                    <option value="inglese">Inglese</option>
                    <option value="spagnolo">Spagnolo</option>
                    <option value="francese">Francese</option>
                    <option value="tedesco">Tedesco</option>
                `;
                cardContent.appendChild(langLabel);
                cardContent.appendChild(langSelect);
            }

            if (promptTemplate.includes("[DETTAGLI]")) {
                const dettagliLabel = document.createElement("label");
                dettagliLabel.textContent = "Dettagli aggiuntivi per il prompt:";
                const dettagliTextarea = document.createElement("textarea");
                dettagliTextarea.placeholder = "Inserisci qui eventuali dettagli specifici o contestuali...";
                dettagliTextarea.id = `dettagli-${index}`;
                cardContent.appendChild(dettagliLabel);
                cardContent.appendChild(dettagliTextarea);
            }

            cardContent.appendChild(buttonGroup);
            cardContent.appendChild(output);
            // Aggiungi l'indicatore di caricamento AI
            cardContent.appendChild(aiLoadingIndicator);


            card.appendChild(cardHeader);
            card.appendChild(cardContent);

            cardHeader.addEventListener("click", () => {
                const isOpen = cardHeader.classList.contains("open");
                cardHeader.classList.toggle("open");
                cardContent.classList.toggle("open");
                cardHeader.setAttribute("aria-expanded", !isOpen);
                cardContent.setAttribute("aria-hidden", isOpen);
            });

            // Gestione apertura/chiusura con tastiera
            cardHeader.addEventListener("keydown", (event) => {
                if (event.key === "Enter" || event.key === " ") {
                    event.preventDefault(); // Evita lo scroll della pagina con la barra spaziatrice
                    cardHeader.click(); // Simula il click
                }
            });

            return card;
        }

        let allPrompts = []; // Variabile per memorizzare tutti i prompt scaricati
        let allCategories = new Set(); // Per memorizzare le categorie uniche

        // Funzione di inizializzazione
        async function init() {
            allPrompts = await fetchPrompts();
            populateCategoryFilter(allPrompts);
            renderCards();
        }

        function populateCategoryFilter(prompts) {
            const categoryFilter = document.getElementById("category-filter");
            allCategories.clear(); // Pulisci il set ogni volta
            prompts.forEach(row => {
                const categoria = row[3]; // La categoria è nella colonna D (indice 3)
                if (categoria) {
                    allCategories.add(categoria.trim());
                }
            });

            // Ordina le categorie alfabeticamente
            const sortedCategories = Array.from(allCategories).sort((a, b) => a.localeCompare(b));

            categoryFilter.innerHTML = '<option value="">Tutte le categorie</option>'; // Mantiene l'opzione "Tutte"
            sortedCategories.forEach(categoria => {
                const option = document.createElement("option");
                option.value = categoria.toLowerCase();
                option.textContent = categoria;
                categoryFilter.appendChild(option);
            });
        }

        function renderCards(selectedCategory = "", searchTerm = "") {
            const promptContainer = document.getElementById("prompt-container");
            promptContainer.innerHTML = ''; // Pulisci il contenitore attuale

            if (allPrompts.length === 0) {
                promptContainer.innerHTML = '<p style="text-align: center; color: #666; font-style: italic; margin-top: 3rem;">Nessun prompt disponibile. Controlla la connessione o la configurazione del foglio.</p>';
                return;
            }

            const filteredPrompts = allPrompts.filter(row => {
                const [titolo, descrizione, , categoria] = row; // Destructuring per prendere titolo, descrizione e categoria
                const matchesCategory = selectedCategory === "" || (categoria && categoria.toLowerCase() === selectedCategory);
                const matchesSearch = searchTerm === "" ||
                                      (titolo && titolo.toLowerCase().includes(searchTerm)) ||
                                      (descrizione && descrizione.toLowerCase().includes(searchTerm));
                return matchesCategory && matchesSearch;
            });

            if (filteredPrompts.length === 0) {
                console.log("DEBUG: 12. Nessun prompt trovato dopo il filtro.");
                promptContainer.innerHTML = '<p style="text-align: center; color: #666; font-style: italic; margin-top: 3rem;">Nessun prompt trovato con i criteri di ricerca selezionati.</p>';
            } else {
                console.log(`DEBUG: 13. Trovati ${filteredPrompts.length} prompt da renderizzare.`);
                filteredPrompts.forEach((row, i) => {
                    const [titolo, descrizione, prompt, categoria, labelTesto, placeholderText, labelLang] = row;
                    const card = creaCard(titolo, descrizione, prompt, categoria, labelTesto, placeholderText, labelLang, i);
                    promptContainer.appendChild(card);
                });
            }
        }

        const categoryFilter = document.getElementById("category-filter");
        categoryFilter.addEventListener("change", () => {
            renderCards(categoryFilter.value, document.getElementById("search-input").value.toLowerCase());
        });

        document.getElementById("search-input").addEventListener("input", e => {
            renderCards(categoryFilter.value, e.target.value.toLowerCase());
        });

        init();
    </script>
</body>
</html>