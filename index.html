<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prompt AI per Giornalisti</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <h1>Generatore di Prompt AI per Giornalisti</h1>
        <p>Crea i tuoi prompt per l'intelligenza artificiale in modo professionale e veloce.</p>
    </header>
    <main>
        <div class="main-content-wrapper">
            <div id="filter-container">
                <select id="category-filter">
                    <option value="">Tutte le categorie</option>
                </select>
                <input type="text" id="search-input" placeholder="Cerca prompt per titolo o descrizione..." />
            </div>
            <div id="prompt-container">
                <div id="loading-spinner" class="spinner-container">
                    <div class="spinner"></div>
                    <span>Caricamento prompt...</span>
                </div>
            </div>
        </div>
    </main>

    <div class="feedback-section">
        <p>Cosa ne pensi dopo i primi test?</p>
        <a href="https://docs.google.com/forms/d/e/1FAIpQLScxgkTY3S5rRAOpGjGteuPzDX41UpNshxmEpKzge__ASIplVA/viewform?usp=dialog"
            target="_blank"
            class="feedback-button">Lascia il tuo feedback!</a>
    </div>

    <div id="copy-confirmation-modal" class="custom-modal-overlay">
        <div class="custom-modal-content">
            <h3>Copia Effettuata!</h3>
            <p>Il seguente prompt è stato copiato negli appunti:</p>
            <pre id="copied-text-display"></pre>
            <button class="close-button">Chiudi</button>
        </div>
    </div>


    <script>
        // Funzione per caricare il file CSV
        async function loadCSV(url) {
            console.log(`DEBUG: 1. Caricamento CSV da: ${url}`);
            const response = await fetch(url);
            if (!response.ok) {
                console.error(`DEBUG: 2. Errore caricamento CSV: ${response.statusText}`);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const csvText = await response.text();
            console.log("DEBUG: 3. CSV caricato con successo. Parsing...");
            return Papa.parse(csvText, { header: false, skipEmptyLines: true }).data;
        }

        // Funzione per creare una singola card di prompt
        function creaCard(titolo, descrizione, prompt, categoria, labelTesto, placeholderText, labelLang, i) {
            console.log(`DEBUG: 6. Creazione card per: ${titolo} (ID: ${i})`);
            const card = document.createElement("div");
            card.className = "prompt-card";
            card.setAttribute("data-category", categoria); // Aggiungi l'attributo categoria

            card.innerHTML = `
                <div class="card-header" id="card-header-${i}">
                    <h3>${titolo}</h3>
                    <span class="icon">&#9660;</span>
                </div>
                <div class="card-content" id="card-content-${i}">
                    <p>${descrizione}</p>
                    <label for="input-${i}">${labelTesto}</label>
                    <input type="text" id="input-${i}" placeholder="${placeholderText}" />

                    <div class="button-group">
                        <div class="button-group-row">
                            <button class="generate-prompt-button" data-index="${i}">Genera Prompt</button>
                            <button class="copy-button" data-target="prompt-output-${i}">Copia Prompt</button>
                        </div>
                        <div class="button-group-row">
                            <button class="ai-generate-button" data-index="${i}">Genera Risposta AI</button>
                            <div class="ai-loading-indicator hidden" id="ai-loading-spinner-${i}">
                                <div class="ai-spinner"></div>
                                <span>Generando risposta AI...</span>
                            </div>
                        </div>
                    </div>

                    <pre class="prompt-output" id="prompt-output-${i}">Il prompt generato apparirà qui.</pre>
                    <div class="note">
                        <strong>Nota:</strong> Il prompt generato sopra è un suggerimento. Ricorda di personalizzarlo ulteriormente per massimizzare l'efficacia con l'AI.
                    </div>

                    <div class="post-output-buttons">
                        <div class="ai-external-control-group">
                            <select class="ai-choice-select" id="ai-choice-${i}">
                                <option value="gemini">Gemini</option>
                                <option value="chatgpt">ChatGPT</option>
                                <option value="copilot">Copilot</option>
                                <option value="perplexity">Perplexity</option>
                            </select>
                            <button class="continue-on-ai-button" data-index="${i}">Vai a AI esterna</button>
                        </div>
                        <button class="reset-button" data-index="${i}">Reset Prompt</button>
                    </div>
                </div>
            `;

            // Logica per accordion
            card.querySelector(".card-header").addEventListener("click", () => {
                console.log(`DEBUG: Click su header card ID: ${i}`);
                const content = card.querySelector(".card-content");
                const header = card.querySelector(".card-header");
                content.classList.toggle("open");
                header.classList.toggle("open");
            });

            // Logica per generazione prompt
            card.querySelector(".generate-prompt-button").addEventListener("click", (event) => {
                const index = event.target.dataset.index;
                const inputElement = document.getElementById(`input-${index}`);
                const promptOutput = document.getElementById(`prompt-output-${index}`);
                const originalPrompt = allPrompts[index][2]; // Il prompt originale dalla colonna 3 del CSV
                const inputValue = inputElement.value;

                let generatedPrompt = originalPrompt.replace("[INPUT]", inputValue);
                promptOutput.textContent = generatedPrompt;
                console.log(`DEBUG: Generato prompt per ID ${index}: ${generatedPrompt}`);
            });

            // Logica per copia prompt
            card.querySelector(".copy-button").addEventListener("click", (event) => {
                const targetId = event.target.dataset.target;
                const textToCopy = document.getElementById(targetId).textContent;

                navigator.clipboard.writeText(textToCopy)
                    .then(() => {
                        console.log(`DEBUG: Testo copiato: ${textToCopy}`);
                        // Mostra il modale di conferma
                        document.getElementById("copied-text-display").textContent = textToCopy;
                        document.getElementById("copy-confirmation-modal").classList.add("show");
                    })
                    .catch(err => {
                        console.error('DEBUG: Errore nella copia: ', err);
                        alert('Impossibile copiare il testo. Si prega di copiare manualmente.');
                    });
            });

            // Logica per reset prompt
            card.querySelector(".reset-button").addEventListener("click", (event) => {
                const index = event.target.dataset.index;
                const inputElement = document.getElementById(`input-${index}`);
                const promptOutput = document.getElementById(`prompt-output-${index}`);

                inputElement.value = ""; // Resetta l'input dell'utente
                promptOutput.textContent = "Il prompt generato apparirà qui."; // Resetta l'output
                console.log(`DEBUG: Reset effettuato per card ID: ${index}`);
            });

            // Logica per generazione risposta AI (simulata)
            card.querySelector(".ai-generate-button").addEventListener("click", (event) => {
                const index = event.target.dataset.index;
                const promptOutput = document.getElementById(`prompt-output-${index}`);
                const loadingSpinner = document.getElementById(`ai-loading-spinner-${index}`);

                promptOutput.textContent = "Generando risposta..."; // Messaggio temporaneo
                loadingSpinner.classList.remove("hidden"); // Mostra lo spinner

                console.log(`DEBUG: Generazione risposta AI simulata per ID: ${index}`);

                // Simula una chiamata API con un ritardo
                setTimeout(() => {
                    promptOutput.textContent = "Questa è una risposta AI simulata basata sul prompt generato. In un'applicazione reale, qui ci sarebbe la risposta di un modello AI.";
                    loadingSpinner.classList.add("hidden"); // Nascondi lo spinner
                    console.log(`DEBUG: Risposta AI simulata completata per ID: ${index}`);
                }, 2000);
            });

            // Logica per "Vai a AI esterna"
            card.querySelector(".continue-on-ai-button").addEventListener("click", (event) => {
                const index = event.target.dataset.index;
                const promptText = document.getElementById(`prompt-output-${index}`).textContent;
                const selectedAI = document.getElementById(`ai-choice-${index}`).value;

                let url = "";
                switch (selectedAI) {
                    case "gemini":
                        url = `https://gemini.google.com/search?q=${encodeURIComponent(promptText)}`;
                        break;
                    case "chatgpt":
                        // ChatGPT non ha un URL diretto per pre-popolare il prompt. Si potrebbe reindirizzare
                        // alla pagina principale o a una chat vuota e fare istruzioni all'utente.
                        // Per questo esempio, reindirizziamo alla pagina principale di ChatGPT.
                        url = "https://chatgpt.com/";
                        alert("Attenzione: ChatGPT non consente il pre-caricamento diretto del prompt. Copia il prompt e incollalo manualmente nella chat.");
                        break;
                    case "copilot":
                        url = `https://copilot.microsoft.com/?q=${encodeURIComponent(promptText)}`;
                        break;
                    case "perplexity":
                        url = `https://www.perplexity.ai/search?q=${encodeURIComponent(promptText)}`;
                        break;
                    default:
                        url = "https://www.google.com/"; // Fallback
                }

                if (url) {
                    window.open(url, '_blank');
                    console.log(`DEBUG: Reindirizzamento a AI esterna (${selectedAI}) con prompt: ${promptText}`);
                }
            });


            return card;
        }

        // Variabile globale per contenere tutti i prompt
        let allPrompts = [];
        let allCategories = new Set(); // Per memorizzare categorie uniche

        document.addEventListener("DOMContentLoaded", () => {
            console.log("DEBUG: DOM caricato. Inizializzazione...");
            init();

            // Logica per chiudere il modale
            document.querySelector("#copy-confirmation-modal .close-button").addEventListener("click", () => {
                document.getElementById("copy-confirmation-modal").classList.remove("show");
            });

            // Chiudi il modale cliccando fuori
            document.getElementById("copy-confirmation-modal").addEventListener("click", (event) => {
                if (event.target.id === "copy-confirmation-modal") {
                    document.getElementById("copy-confirmation-modal").classList.remove("show");
                }
            });
        });

        async function init() {
            const promptContainer = document.getElementById("prompt-container");
            const loadingSpinner = document.getElementById("loading-spinner");
            const categoryFilter = document.getElementById("category-filter");

            // Nascondi lo spinner all'inizio
            loadingSpinner.classList.remove("hidden");
            promptContainer.innerHTML = ''; // Pulisci il contenuto esistente

            try {
                // Carica PapaParse dinamicamente
                await new Promise(resolve => {
                    const script = document.createElement('script');
                    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js';
                    script.onload = resolve;
                    document.head.appendChild(script);
                    console.log("DEBUG: 4. Caricamento PapaParse...");
                });
                console.log("DEBUG: 5. PapaParse caricato.");

                allPrompts = await loadCSV("data/prompts.csv");
                // Rimuovi l'intestazione se presente (prima riga del CSV)
                if (allPrompts.length > 0 && allPrompts[0][0].toLowerCase() === 'titolo') {
                    allPrompts.shift();
                }
                console.log("DEBUG: 7. Dati prompt caricati e pronti.");

                // Popola le categorie
                allPrompts.forEach(row => {
                    allCategories.add(row[3]); // La categoria è nella 4a colonna (indice 3)
                });

                allCategories.forEach(category => {
                    const option = document.createElement("option");
                    option.value = category;
                    option.textContent = category;
                    categoryFilter.appendChild(option);
                });
                console.log("DEBUG: 8. Categorie caricate e popolate.");

                renderCards(); // Renderizza tutte le card inizialmente
                loadingSpinner.classList.add("hidden"); // Nascondi lo spinner una volta caricate le card
                console.log("DEBUG: 14. Spinner nascosto. Inizializzazione completata.");

            } catch (error) {
                console.error("DEBUG: Errore durante l'inizializzazione:", error);
                loadingSpinner.classList.add("hidden");
                promptContainer.innerHTML = '<p style="text-align: center; color: #d9534f; margin-top: 3rem;">Errore nel caricamento dei prompt. Si prega di riprovare più tardi.</p>';
            }

            // Funzione per renderizzare le card in base ai filtri
            function renderCards(category = "", searchTerm = "") {
                console.log(`DEBUG: 9. Rendering card con Categoria: "${category}", Ricerca: "${searchTerm}"`);
                promptContainer.innerHTML = ''; // Pulisci il contenitore prima di renderizzare

                const filteredPrompts = allPrompts.filter(row => {
                    const [titolo, descrizione, , categoria] = row; // Destructuring per prendere i valori rilevanti
                    const matchesCategory = category === "" || categoria === category;
                    const matchesSearch =
                        (titolo && titolo.toLowerCase().includes(searchTerm)) ||
                        (descrizione && descrizione.toLowerCase().includes(searchTerm));
                    return matchesCategory && matchesSearch;
                });

                if (filteredPrompts.length === 0) {
                    console.log("DEBUG: 12. Nessun prompt trovato dopo il filtro.");
                    promptContainer.innerHTML = '<p style="text-align: center; color: #666; font-style: italic; margin-top: 3rem;">Nessun prompt trovato con i criteri di ricerca selezionati.</p>';
                } else {
                    console.log(`DEBUG: 13. Trovati ${filteredPrompts.length} prompt da renderizzare.`);
                    filteredPrompts.forEach((row, i) => {
                        const [titolo, descrizione, prompt, categoria, labelTesto, placeholderText, labelLang] = row;
                        const card = creaCard(titolo, descrizione, prompt, categoria, labelTesto, placeholderText, labelLang, i);
                        promptContainer.appendChild(card);
                    });
                }
            }

            categoryFilter.addEventListener("change", () => {
                renderCards(categoryFilter.value, document.getElementById("search-input").value.toLowerCase());
            });

            document.getElementById("search-input").addEventListener("input", e => {
                renderCards(categoryFilter.value, e.target.value.toLowerCase());
            });

            renderCards();
        }

        init();
    </script>
</body>
</html>