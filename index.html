<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prompt AI per Giornalisti</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <h1>Generatore di Prompt AI per Giornalisti</h1>
        <p>Personalizza i tuoi prompt per l'intelligenza artificiale a partire da template professionali.</p>
    </header>
    <main>
        <div class="main-content-wrapper">
            <div id="filter-container">
                <select id="category-filter">
                    <option value="">Tutte le categorie</option>
                </select>
                <input type="text" id="search-input" placeholder="Cerca prompt per titolo o descrizione..." />
            </div>
            <div id="prompt-container">
                <div id="loading-spinner" class="spinner-container">
                    <div class="spinner"></div>
                    <span>Caricamento prompt...</span>
                </div>
            </div>
        </div>
    </main>

    <div class="feedback-section">
        <p>Cosa ne pensi dopo i primi test?</p>
        <a href="https://docs.google.com/forms/d/e/1FAIpQLScxgkTY3S5rRAOpGjGteuPzDX41UpNshxmEpKzge__ASIplVA/viewform?usp=dialog"
            target="_blank"
            class="feedback-button">Lascia un Feedback</a>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script> <script>
        // ID del tuo Foglio Google - Questo DEVE rimanere fisso qui per l'app
        const sheetID = "1uDoHvedmUcczP4rjI0GNZWOWstMPfhYuUahNPPbMoxg";
        const sheetRange = "Prompt Prestabiliti!A2:G"; // <-- Il range rimane lo stesso

        // L'URL della tua Netlify Function per Google Sheets
        const NETLIFY_FUNCTION_URL = "/.netlify/functions/get-my-sheets";

        // --- INIZIO AGGIUNTE PER INTEGRAZIONE GEMINI ---
        // L'URL della tua Netlify Function per Gemini
        const GEMINI_FUNCTION_URL = "/.netlify/functions/call-gemini";
        // --- FINE AGGIUNTE PER INTEGRAZIONE GEMINI ---

        const promptContainer = document.getElementById("prompt-container");
        const loadingSpinner = document.getElementById("loading-spinner");

        async function fetchPrompts() {
            // Mostra lo spinner prima di iniziare il fetch
            loadingSpinner.classList.remove("hidden");
            promptContainer.innerHTML = ''; // Pulisci il container per sicurezza prima di mostrare lo spinner

            try {
                const response = await fetch(NETLIFY_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ sheetId: sheetID, sheetRange: sheetRange }), // Qui vengono passati i dati
                });

                console.log("DEBUG: 1. Sto provando a scaricare i prompt da Netlify Function.");

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error(`DEBUG: 2. Errore nella risposta della Netlify Function: ${response.status}. Dettagli:`, errorData);
                    throw new Error(`Errore nel caricamento dei dati: ${errorData.error || response.statusText}`);
                }

                const data = await response.json();
                console.log("DEBUG: 3. Dati RAW ricevuti dalla Netlify Function:", data);

                if (!data.values || data.values.length === 0) {
                    console.warn("DEBUG: 4. Nessun dato 'values' trovato nel foglio o foglio vuoto.");
                }
                return data.values || [];
            } catch (error) {
                console.error("DEBUG: 5. Errore CATCH durante il recupero dei prompt dalla Netlify Function:", error);
                alert("Si è verificato un errore nel caricamento dei prompt. Riprova più tardi o controlla la configurazione della funzione Netlify.");
                return [];
            } finally {
                // Nascondi lo spinner una volta che il fetch è completato (sia successo che fallimento)
                loadingSpinner.classList.add("hidden");
            }
        }

        function creaCard(titolo, descrizione, promptTemplate, categoria, labelTesto, placeholderText, labelLang, index) {
            console.log(`DEBUG: 6. CreaCard chiamata per "${titolo}" - promptTemplate: "${promptTemplate}" - labelLang (Col. G): "${labelLang}"`);

            const card = document.createElement("div");
            card.className = "prompt-card";
            card.dataset.categoria = categoria?.toLowerCase() || "";

            const cardHeader = document.createElement("div");
            cardHeader.className = "card-header";
            cardHeader.setAttribute("role", "button");
            cardHeader.setAttribute("aria-expanded", "false");
            cardHeader.setAttribute("tabindex", "0");

            const headerTitle = document.createElement("h3");
            headerTitle.textContent = titolo;

            const icon = document.createElement("span");
            icon.className = "icon";
            icon.innerHTML = "&#9660;";

            cardHeader.appendChild(headerTitle);
            cardHeader.appendChild(icon);

            const cardContent = document.createElement("div");
            cardContent.className = "card-content";
            cardContent.setAttribute("aria-hidden", "true");

            const descElement = document.createElement("p");
            descElement.textContent = descrizione;

            const esperienzaLabel = document.createElement("label");
            esperienzaLabel.textContent = "Tema o campo di esperienza principale:";
            const esperienzaInput = document.createElement("input");
            esperienzaInput.placeholder = "es. economia, esteri, politica...";
            esperienzaInput.id = `esperienza-${index}`;

            const genereLabel = document.createElement("label");
            genereLabel.textContent = "Genere di giornalismo:";
            const genereInput = document.createElement("input");
            genereInput.placeholder = "es. cronaca, cultura, sport...";
            genereInput.id = `genere-${index}`;

            const testataLabel = document.createElement("label");
            testataLabel.textContent = "Nome della testata:";
            const testataInput = document.createElement("input");
            testataInput.placeholder = "es. Il Sole 24 Ore, La Repubblica...";
            testataInput.id = `testata-${index}`;

            const output = document.createElement("div");
            output.className = "prompt-output";
            // Inizialmente, impostiamo un messaggio di base. Marked.parse verrà usato dopo.
            output.innerHTML = "Il prompt personalizzato apparirà qui dopo la generazione.";

            // --- INIZIO AGGIUNTE PER CARICAMENTO AI ---
            const aiLoadingIndicator = document.createElement("div");
            aiLoadingIndicator.className = "ai-loading-indicator";
            aiLoadingIndicator.style.display = 'none'; // Inizialmente nascosto
            aiLoadingIndicator.innerHTML = '<div class="ai-spinner"></div><span>Generazione risposta AI...</span>';
            // --- FINE AGGIUNTE PER CARICAMENTO AI ---

            const buttonGroup = document.createElement("div");
            buttonGroup.className = "button-group";

            const generatePromptButton = document.createElement("button");
            generatePromptButton.textContent = "Genera prompt";
            generatePromptButton.className = "generate-prompt-button"; // Nuova classe per distinguere
            generatePromptButton.onclick = () => {
                let finalPrompt = promptTemplate
                    .replace(/\[ESPERIENZA\]/g, esperienzaInput.value || "[ESPERIENZA]")
                    .replace(/\[GENERE\]/g, genereInput.value || "[GENERE]")
                    .replace(/\[TESTATA\]/g, testataInput.value || "[TESTATA]");

                const textAreaInput = cardContent.querySelector(`#area-text-${index}`);
                if (textAreaInput) {
                    finalPrompt = finalPrompt.replace(/\[AREA_TEXT\]/g, textAreaInput.value || "[AREA_TEXT]");
                } else {
                    finalPrompt = finalPrompt.replace(/\[AREA_TEXT\]/g, '');
                }

                const langSelect = cardContent.querySelector(`#lang-${index}`);
                if (langSelect) {
                    finalPrompt = finalPrompt.replace(/\[LANG\]/g, langSelect.value || "[LANG]");
                } else {
                    finalPrompt = finalPrompt.replace(/\[LANG\]/g, '');
                }

                if (promptTemplate.includes("[DETTAGLI]")) {
                    const dettagliInput = cardContent.querySelector(`#dettagli-${index}`);
                    finalPrompt = finalPrompt.replace(/\[DETTAGLI\]/g, dettagliInput ? dettagliInput.value || "[DETTAGLI]" : "[DETTAGLI]");
                }

                // *** CORREZIONE QUI: Usa marked.parse per il prompt generato ***
                output.innerHTML = marked.parse(finalPrompt);
                output.style.color = '#444'; // Colore normale del testo del prompt
            };

            const copyButton = document.createElement("button");
            copyButton.textContent = "Copia prompt";
            copyButton.className = "copy-button";
            copyButton.onclick = () => {
                // Per copiare il testo corretto, prendiamo il testo dal div output.
                // Se `marked.parse` è stato usato, `innerText` restituirà il testo "pulito" (senza tag HTML)
                const textToCopy = output.innerText;
                const tempTextarea = document.createElement("textarea");
                tempTextarea.value = textToCopy;
                document.body.appendChild(tempTextarea);
                tempTextarea.select();
                document.execCommand("copy");
                document.body.removeChild(tempTextarea);
                copyButton.textContent = "Copiato!";
                setTimeout(() => copyButton.textContent = "Copia prompt", 1500);
            };

            // --- INIZIO AGGIUNTE PER IL BOTTONE "GENERA RISPOSTA AI" ---
            const generateAIResponseButton = document.createElement("button");
            generateAIResponseButton.textContent = "Genera risposta AI";
            generateAIResponseButton.className = "ai-generate-button";
            generateAIResponseButton.onclick = async () => {
                // 1. Assicurati che il prompt sia già stato generato
                // Qui usiamo il prompt generato dal bottone 'Genera prompt', ma il suo valore puro
                let finalPromptForAI = promptTemplate
                    .replace(/\[ESPERIENZA\]/g, esperienzaInput.value || "[ESPERIENZA]")
                    .replace(/\[GENERE\]/g, genereInput.value || "[GENERE]")
                    .replace(/\[TESTATA\]/g, testataInput.value || "[TESTATA]");

                const textAreaInput = cardContent.querySelector(`#area-text-${index}`);
                if (textAreaInput) {
                    finalPromptForAI = finalPromptForAI.replace(/\[AREA_TEXT\]/g, textAreaInput.value || "[AREA_TEXT]");
                } else {
                    finalPromptForAI = finalPromptForAI.replace(/\[AREA_TEXT\]/g, '');
                }

                const langSelect = cardContent.querySelector(`#lang-${index}`);
                if (langSelect) {
                    finalPromptForAI = finalPromptForAI.replace(/\[LANG\]/g, langSelect.value || "[LANG]");
                } else {
                    finalPromptForAI = finalPromptForAI.replace(/\[LANG\]/g, '');
                }

                if (promptTemplate.includes("[DETTAGLI]")) {
                    const dettagliInput = cardContent.querySelector(`#dettagli-${index}`);
                    finalPromptForAI = finalPromptForAI.replace(/\[DETTAGLI\]/g, dettagliInput ? dettagliInput.value || "[DETTAGLI]" : "[DETTAGLI]");
                }

                // Controlla se il prompt è ancora nel suo stato iniziale o di errore
                if (!finalPromptForAI || output.innerHTML.includes("Il prompt personalizzato apparirà qui dopo la generazione.")) {
                    alert("Per favore, genera prima il prompt personalizzato.");
                    return;
                }


                // 2. Mostra l'indicatore di caricamento
                aiLoadingIndicator.style.display = 'flex'; // Mostra il contenitore flex per spinner e testo
                output.innerHTML = "Generazione della risposta AI in corso..."; // Messaggio temporaneo
                output.style.color = '#888'; // Colore per indicare stato di caricamento

                try {
                    const response = await fetch(GEMINI_FUNCTION_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ prompt: finalPromptForAI }), // Passa il prompt pulito all'AI
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("Errore nella risposta della Cloud Function Gemini:", errorData);
                        output.innerHTML = `Errore AI: ${errorData.error || response.statusText}. Riprova.`;
                        output.style.color = '#cc0000'; // Colore per errore
                        return;
                    }

                    const data = await response.json();
                    if (data.aiResponse) {
                        // CONVERTI IL MARKDOWN IN HTML QUI
                        output.innerHTML = marked.parse(data.aiResponse);
                        output.style.color = '#222'; // Colore normale per la risposta AI
                    } else {
                        output.innerHTML = "Nessuna risposta valida dall'AI.";
                        output.style.color = '#cc0000';
                    }

                } catch (error) {
                    console.error("Errore durante la chiamata alla Cloud Function Gemini:", error);
                    output.innerHTML = `Errore di connessione: ${error.message}. Verifica la console per dettagli.`;
                    output.style.color = '#cc0000';
                } finally {
                    // 3. Nascondi l'indicatore di caricamento
                    aiLoadingIndicator.style.display = 'none';
                }
            };
            // --- FINE AGGIUNTE PER IL BOTTONE "GENERA RISPOSTA AI" ---

            cardContent.appendChild(descElement);
            cardContent.appendChild(esperienzaLabel);
            cardContent.appendChild(esperienzaInput);
            cardContent.appendChild(genereLabel);
            cardContent.appendChild(genereInput);
            cardContent.appendChild(testataLabel);
            cardContent.appendChild(testataInput);

            const shouldShowTextArea = promptTemplate.includes("[AREA_TEXT]");

            if (shouldShowTextArea) {
                console.log(`DEBUG: 7. Card "${titolo}" include [AREA_TEXT]. Aggiungo campo testo.`);
                const testoLabel = document.createElement("label");
                const testoInput = document.createElement("textarea");
                testoInput.rows = 4;
                testoInput.id = `area-text-${index}`;

                testoLabel.textContent = typeof labelTesto === 'string' && labelTesto.trim() !== '' ? labelTesto : "Incolla qui il testo da elaborare:";
                testoInput.placeholder = typeof placeholderText === 'string' && placeholderText.trim() !== '' ? placeholderText : "Incolla qui il testo...";

                cardContent.appendChild(testoLabel);
                cardContent.appendChild(testoInput);
            }

            // Aggiungo il campo lingua se [LANG] è nel promptTemplate
            if (promptTemplate.includes("[LANG]")) {
                console.log(`DEBUG: 8. Card "${titolo}" include [LANG]. Aggiungo menu a discesa lingua.`);
                const langLabel = document.createElement("label");
                langLabel.textContent = typeof labelLang === 'string' && labelLang.trim() !== '' ? labelLang : "Lingua di destinazione:";
                const langSelect = document.createElement("select");
                langSelect.id = `lang-${index}`;

                const lingue = [
                    "Italiano",
                    "Inglese USA",
                    "Inglese UK",
                    "Afrikaans", "Arabo", "Bengali", "Cinese", "Danese", "Ebraico", "Finlandese",
                    "Francese", "Giapponese", "Hindi", "Indonesiano", "Olandese", "Persiano",
                    "Polacco", "Portoghese", "Russo", "Spagnolo", "Svedese", "Thai", "Turco", "Vietnamita"
                ];

                const sortedOtherLanguages = lingue.filter(lang => !["Italiano", "Inglese USA", "Inglese UK"].includes(lang)).sort();
                const orderedLanguages = ["Italiano", "Inglese USA", "Inglese UK", ...sortedOtherLanguages];

                orderedLanguages.forEach(lingua => {
                    const option = document.createElement("option");
                    option.value = lingua;
                    option.textContent = lingua;
                    langSelect.appendChild(option);
                });

                cardContent.appendChild(langLabel);
                cardContent.appendChild(langSelect);
            } else {
                console.log(`DEBUG: 9. Card "${titolo}" NON include [LANG]. NON aggiungo menu a discesa lingua.`);
            }

            if (titolo === "Correggi testi da allegati PDF" || titolo === "Correzione bozze") {
                const note = document.createElement("p");
                note.className = "note";
                note.textContent = "Ricordati di fornire il file o il testo da correggere alla tua IA di fiducia insieme al tuo prompt.";
                cardContent.appendChild(note);
            } else if (titolo === "Ricava testi da allegati") {
                const note = document.createElement("p");
                note.className = "note";
                note.textContent = "Ricordati di fornire il file da cui vuoi che l'AI ricavi il testo (può essere un png, un jpg, un pdf...).";
                cardContent.appendChild(note);

                const dettagliLabel = document.createElement("label");
                dettagliLabel.textContent = "Altri dettagli (se presenti nel prompt originale):";
                const dettagliInput = document.createElement("input");
                dettagliInput.placeholder = "aggiungere qui personalizzazioni per lo specifico caso/documento";
                dettagliInput.id = `dettagli-${index}`;
                cardContent.appendChild(dettagliLabel);
                cardContent.appendChild(dettagliInput);
            }

            buttonGroup.appendChild(generatePromptButton);
            buttonGroup.appendChild(copyButton);
            buttonGroup.appendChild(generateAIResponseButton); // Aggiungi il nuovo bottone AI

            cardContent.appendChild(buttonGroup);
            cardContent.appendChild(aiLoadingIndicator); // Aggiunto l'indicatore di caricamento AI
            cardContent.appendChild(output);

            card.appendChild(cardHeader);
            card.appendChild(cardContent);

            cardHeader.onclick = () => {
                const isOpen = cardContent.style.display === "block";
                if (isOpen) {
                    cardContent.style.display = "none";
                    cardHeader.classList.remove("open");
                    cardContent.classList.remove("open");
                    cardHeader.setAttribute("aria-expanded", "false");
                    cardContent.setAttribute("aria-hidden", "true");
                } else {
                    document.querySelectorAll('.card-content.open').forEach(openContent => {
                        openContent.style.display = "none";
                        openContent.classList.remove("open");
                        openContent.previousElementSibling.classList.remove("open");
                        openContent.previousElementSibling.setAttribute("aria-expanded", "false");
                        openContent.setAttribute("aria-hidden", "true");
                    });

                    cardContent.style.display = "block";
                    cardHeader.classList.add("open");
                    cardContent.classList.add("open");
                    cardHeader.setAttribute("aria-expanded", "true");
                    cardContent.setAttribute("aria-hidden", "false");
                }
            };

            cardHeader.onkeydown = (event) => {
                if (event.key === "Enter" || event.key === " ") {
                    event.preventDefault();
                    cardHeader.click();
                }
            };

            return card;
        }

        async function init() {
            const prompts = await fetchPrompts();

            if (prompts.length === 0) {
                console.error("DEBUG: 10. La lista dei prompt è vuota. Non posso creare le categorie o renderizzare le card.");
                promptContainer.innerHTML = '<p style="text-align: center; color: #cc0000; font-weight: bold; margin-top: 3rem;">Errore: Impossibile caricare i prompt dal Google Sheet. Verifica la configurazione della funzione Netlify.</p>';
                return;
            }

            const categorieUniche = new Set();
            prompts.forEach(row => {
                const cat = row[3]; // Colonna D (categoria)
                if (cat) categorieUniche.add(cat.toLowerCase());
            });
            const categoryFilter = document.getElementById("category-filter");
            Array.from(categorieUniche).sort().forEach(cat => {
                const option = document.createElement("option");
                option.value = cat;
                option.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
                categoryFilter.appendChild(option);
            });

            function renderCards(filterCategoria = "", searchTerm = "") {
                loadingSpinner.classList.add("hidden");

                promptContainer.innerHTML = ""; // Pulisci il container prima di aggiungere le card
                const filteredPrompts = prompts.filter((row) => {
                    if (row.length < 6) {
                        console.warn("DEBUG: 11. Riga del foglio con meno di 6 colonne, saltata in fase di filtro:", row);
                        return false;
                    }
                    const [titolo, descrizione, prompt, categoria, labelTesto, placeholderText, labelLang] = row;

                    const matchesCategory = !filterCategoria || (categoria && categoria.toLowerCase() === filterCategoria);
                    const matchesSearch = !searchTerm ||
                                                (titolo && titolo.toLowerCase().includes(searchTerm)) ||
                                                (descrizione && descrizione.toLowerCase().includes(searchTerm));
                    return matchesCategory && matchesSearch;
                });

                if (filteredPrompts.length === 0) {
                    console.log("DEBUG: 12. Nessun prompt trovato dopo il filtro.");
                    promptContainer.innerHTML = '<p style="text-align: center; color: #666; font-style: italic; margin-top: 3rem;">Nessun prompt trovato con i criteri di ricerca selezionati.</p>';
                } else {
                    console.log(`DEBUG: 13. Trovati ${filteredPrompts.length} prompt da renderizzare.`);
                    filteredPrompts.forEach((row, i) => {
                        const [titolo, descrizione, prompt, categoria, labelTesto, placeholderText, labelLang] = row;
                        const card = creaCard(titolo, descrizione, prompt, categoria, labelTesto, placeholderText, labelLang, i);
                        promptContainer.appendChild(card);
                    });
                }
            }

            categoryFilter.addEventListener("change", () => {
                renderCards(categoryFilter.value, document.getElementById("search-input").value.toLowerCase());
            });

            document.getElementById("search-input").addEventListener("input", e => {
                renderCards(categoryFilter.value, e.target.value.toLowerCase());
            });

            renderCards();
        }

        init();
    </script>
</body>
</html>